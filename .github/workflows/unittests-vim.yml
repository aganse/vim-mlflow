name: Unit Tests (Vimscript)

on:
  push:
  pull_request:

jobs:
  vim-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Vim and Neovim
        run: |
          sudo apt-get update
          sudo apt-get install -y vim neovim
      - name: Run Vimscript tests (Neovim then Vim)
        run: |
          set +e
          rm -f nvim-test.log vim-test.log

          echo
          echo "Starting Neovim unittest"
          nvim --headless -u NONE -i NONE -V1nvim-test.log \
            -c "source tests/vim/run_tests.vim" \
            -c "qa"
          nvim_status=$?
          if [ $nvim_status -ne 0 ]; then
            echo "Neovim test failed:"
            cat nvim-test.log
          fi

          echo
          echo "Starting Vim unittest"
          vim -E -u NONE -i NONE -V1vim-test.log \
            -c "source tests/vim/run_tests.vim" \
            -c "qa"
          vim_status=$?
          if [ $vim_status -ne 0 ]; then
            echo "Vim test failed:"
            cat vim-test.log
          fi

          rm -f nvim-test.log vim-test.log

          if [ $nvim_status -ne 0 ] || [ $vim_status -ne 0 ]; then
            exit 1
          fi
