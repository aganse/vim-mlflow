name: Unit Tests (Vimscript)

on:
  push:
  pull_request:

jobs:
  vim-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        editor: [nvim, vim]
    steps:
      - uses: actions/checkout@v4
      - name: Install editor
        run: |
          sudo apt-get update
          if [ "${{ matrix.editor }}" = "nvim" ]; then
            sudo apt-get install -y neovim
          else
            sudo apt-get install -y vim
          fi
      - name: Run Vimscript tests
        run: |
          if [ "${{ matrix.editor }}" = "nvim" ]; then
            echo
            echo Starting NVim unittest
            nvim --headless -u NONE -i NONE -V1nvim-test.log \
              -c "source tests/vim/run_tests.vim" \
              -c "qa" \
              || { cat nvim-test.log; rm -f nvim-test.log; exit 1; }
            rm -f nvim-test.log
          else
            echo
            echo Starting Vim unittest
            vim -E -u NONE -i NONE -V1vim-test.log \
              -c "source tests/vim/run_tests.vim" \
              -c "qa" \
              || { cat vim-test.log; rm -f vim-test.log; exit 1; }
            rm -f vim-test.log
          fi
